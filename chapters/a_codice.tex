\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstset{
	basicstyle=\footnotesize \ttfamily,
	commentstyle=\color{mygreen},
	keywordstyle=\color{blue},
	stringstyle=\color{mymauve},
	numbers=none,
	%numberstyle=\tiny\color{lightgray},
	%numbersep=5pt,
	%frame=single,
	rulecolor=\color{mygray}, 
	breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
	breaklines=true,                 % sets automatic line breaking
	tabsize=4
}

\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}

%define Javascript language
\lstdefinelanguage{JavaScript}{
	keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
	keywordstyle=\color{blue}\bfseries,
	ndkeywords={class, export, boolean, throw, implements, import, this},
	ndkeywordstyle=\color{darkgray}\bfseries,
	identifierstyle=\color{black},
	sensitive=false,
	comment=[l]{//},
	morecomment=[s]{/*}{*/},
	commentstyle=\color{purple}\ttfamily,
	stringstyle=\color{red}\ttfamily,
	morestring=[b]',
	morestring=[b]"
}

\lstset{
	language=JavaScript,
	extendedchars=true,
	basicstyle=\footnotesize\ttfamily,
	showstringspaces=false,
	showspaces=false,
	numbers=none,
	numberstyle=\footnotesize,
	numbersep=9pt,
	tabsize=2,
	breaklines=true,
	showtabs=false,
	captionpos=b
}

%\section{Costruzione della rete}
%	\lstinputlisting[language=bash]{chapters/code/build.sh}
	
%\section{Configurazione crypto-tool}
%	\lstinputlisting{chapters/code/crypto-config.yaml}
	
%\section{Configurazione configtxgen}
%	\lstinputlisting{chapters/code/configtx.yaml}

%\section{Compose}
%	\lstinputlisting{chapters/code/docker-compose.yml}
	
\section{Utilizzo del composer}
	\subsection{Creare una nuova struttura di rete}
		Il concetto chiave nell'utilizzo di Hyperledger Composer è la \emph{``business network definition" (BND)}, che definisce il modello dei dati, le regole di accesso e la logica delle transazioni della nostra rete. Per creare la scheletro del progetto si può usare Yeoman generator, installato in precedenza assieme al Composer:
\begin{lstlisting}
yo hyperledger-composer:businessnetwork
\end{lstlisting}
		Inseriamo ``voting-network" come nome della rete e ``eurasia.voting" come namespace.
	\subsection{Definire le caratteristiche della rete}
		La nostra rete si fonda su asset (e.g i raggruppamenti di votanti), partecipanti (e.g votanti e candidati), transazioni come quella che permette ad un utente di votare e query che consentano la consultazione agevole dei dati. Come output del comando precedente, c'è un file di modello (\emph{.cto}) che conterrà le definizioni di ciascuna classe di asset, transazioni, partecipanti ed eventi. Il contenuto di questo file sarà:
\begin{lstlisting}
/**
* My voting network
*/

namespace eurasia.voting

asset VotingGroup identified by groupId {
	o String groupId
	--> Voter[] members
}

asset Vote identified by voteSig {
	o String voteSig
	--> VotingGroup group
	--> Candidate recipient
}

participant Voter identified by voterId {
	o String voterId
	o String firstName
	o String lastName
}

participant Candidate identified by candidateId {
	o String candidateId
	o String firstName
	o String lastName
	o Integer balance
}

transaction Voting {
	o String signature
	--> VotingGroup group
	--> Candidate recipient
}
\end{lstlisting}
	\subsection{Scrivere la logica delle transazioni in JavaScript}
		Nel file di modello è stata definita una transazione \emph{Vote}, il cui scopo è quello di creare un nuovo voto ed indirizzarlo al candidato prescelto. Editiamo il file \emph{logic.js} per specificare il comportamento di questa transazione usando il linguaggio JavaScript, prestando attenzione ad utilizzare la sintassi accettata dal Transaction processor di Composer.
\begin{lstlisting}[language=JavaScript]
/**
* Vote for a candidate
* @param {eurasia.voting.Voting} voting - the vote to be processed
* @transaction
*/
function newVote(voting) {	
	// Get the factory for creating new asset instances
	var factory = getFactory();
	// Create the vote.
	var vote = factory.newResource('eurasia.voting', 'Vote', computeSig(voting.signature));
	vote.group = voting.group;
	vote.recipient = voting.recipient;
	voting.recipient.balance++;
	return getAssetRegistry('eurasia.voting.Vote')
		.then(function (assetRegistry) {
			// Update the asset in the asset registry. Again, note
			// that update() returns a promise, so so we have to return
			// the promise so that Composer waits for it to be resolved.
			return assetRegistry.add(vote)
		})
		.then(function () {
			return getParticipantRegistry('eurasia.voting.Candidate')
		})
		.then(function (participantRegistry) {
			return participantRegistry.update(voting.recipient);
		});
}

/*
* This function should represent the implementation of a linkable ring signature algorythm. In this PoC it will return a simple timestamp + an arbitrary id
*/
function computeSig(mySig){
	var sig = new Date().valueOf();
	sig += mySig;
	return sig;
}

\end{lstlisting}
	\subsection{Aggiungere il controllo agli accessi}
		Creiamo il file \emph{permissions.acl} nella cartella \emph{voting-network}, e al suo interno specifichiamo le regole per il controllo degli accessi in questo modo:
\begin{lstlisting}
/**
* Access control rules for voting-network
*/
rule Vote {
	description: "Allow all voters to vote through a transaction"
	participant: "eurasia.voting.Voter"
	operation: CREATE, UPDATE
	resource: "eurasia.voting.Vote"
	transaction: "eurasia.voting.Voting"
	action: ALLOW
}

rule SystemACL {
	description:  "System ACL to permit all access"
	participant: "ANY"
	operation: ALL
	resource: "org.hyperledger.composer.system.**"
	action: ALLOW
}

rule NetworkAdminUser {
	description: "Grant business network administrators full access to user resources"
	participant: "org.hyperledger.composer.system.NetworkAdmin"
	operation: ALL
	resource: "**"
	action: ALLOW
}

rule NetworkAdminSystem {
	description: "Grant business network administrators full access to system resources"
	participant: "org.hyperledger.composer.system.NetworkAdmin"
	operation: ALL
	resource: "org.hyperledger.composer.system.**"
	action: ALLOW
}
\end{lstlisting}

\section{Generare il Business network archive}
	Terminata la definizione delle proprietà della rete è necessario impacchettarla in un file \emph{.bna} che rappresenta un archivio esportabile da cui poter poi effettuare il deploy su un sottostante sistema Fabric.
	Per fare ciò è necessario:
	\begin{itemize}
		\item Spostarsi nella cartella \emph{voting-network}
		\item Lanciare il seguente comando da terminale:
			\begin{lstlisting}
composer archive create -t dir -n .
			\end{lstlisting}
	\end{itemize}
	Al termine dell'esecuzione potremo trovare un file chiamato \emph{voting-network@0.0.1.bna} nella cartella da cui abbiamo lanciato il comando.